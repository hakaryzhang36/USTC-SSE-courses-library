# 多播地址
## 地址分配
目的：通过多播地址，确定多播组，组内主机用同一个多播地址。

一台主机有 1 个单播地址和 1 个多播地址；一张网卡也有 1 个单播 MAC 地址和 1 个多播 MAC 地址。

地址范围：224.0.0.0 ~ 239.255.255.255

## 确定多播 MAC 地址
高25位不变 0x00，低 23 位取自多播 IP 的低 23 位。
![[attachments/Pasted image 20221102144052.png]]
由于剩下多播 IP 中剩下 5 位是可变的，但 MAC 地址采用，所以可能出现多个多播 IP 对应到同一个 MAC 地址的情况（但几率小，问题不大）。

# 网际组管理协议 IGMP

**报文分类**
- 成员查询报文 Membership Query
- 成员报告报文 Membership Report

## 成员查询报文 Membership Query
### 报文格式
![[attachments/Pasted image 20221102145928.png]]
- Response code：响应时间要求
- Group address：指定组内查询，全 0 无指定
- Source address：需要查询的源地址，源地址是单播地址。

根据组地址和源地址是否指定，可以再细分为三类查询报文。
![[attachments/Pasted image 20221102150440.png]]

## 成员报告报文 Membership Report
## 报文格式
![[attachments/Pasted image 20221102150640.png]]


## 多播管理
## 多播组状态
在一条 Group Record 中，Record Type 字段标识了这个多播组的状态。状态如下。
![[attachments/Pasted image 20221102155254.png]]
比如说，当一个多播组要加入了新的源，则要向所有组内成员间发送 Record Type = include 的 Report 报文，将新的源写入节点的接口状态表对应的多播组中。

### 接口状态表
在一台主机上，不同进程在不同的多播组内，对应接收的源地址也不同（include：接收，exclude：不接受），有表如下。
![[attachments/Pasted image 20221102155627.png]]

主机/路由器的网络接口（网卡）会把上表总结如下。
![[attachments/Pasted image 20221102154246.png]]
Group Timer 表示延迟发送报告报文的时间，目的是为了发送最新最全的组状态。

**通过 Query/Report 报文，维护节点的接口状态表，即可管理多播组。**

# 多播路由树
## 源节点树
对每个组内成员节点，通过计算最短路径树得到到达所有成员的路由。

## 组共享树 RPT
**核心路由器 Core Router**：掌握到达所有成员网络的最优路径。多播源先通过单播发送数据到核心路由器，再由核心路由器单播转发。
![[attachments/Pasted image 20221102161945.png]]

# 多播路由协议
![[attachments/Pasted image 20221102172801.png]]
## 多播链路状态路由协议：MOSPF
**基于源节点树**。在 OSPF 的基础上，增加了一类 **group-menmbership-LSA** 报文用于记录多播组成员关系，在 AS 内部泛洪，每个路由器计算最短路径树。

## 多播距离向量路由协议：DVMRP
**基于源节点树**，但不需要通过记录路由来得到源节点树，只需要记录那些端口。以下

### 泛洪
路由器收到多播分组直接广播转发到所有接口，保证所有成员都收到。

### 反向转发 RPF
泛洪可能导致路由环路，为了解决这个问题，通过**反向转发**，比较收到分组的源地址在单播路由表中的下一跳 IP（相当于查询发往源地址的下一跳 IP）和当前报文的上一跳 IP，如果相同则表示来自最短路径，接收该分组。

### 反向路径广播 RPB
反向转发并不能解决网络内重复多播报文的转发问题。

**反向路径广播** RPB 要求路由器只能广播来自父路由器（指定）的多播报文，从而消除了环路。

如何得到父路由器呢？其实也是看单播路由表，源地址的下一跳就是该路由器的父路由器。

### 反向路径多播 RPM
为了不用广播到无用接口从而实现真正的多播，需要加入**剪枝、嫁接**的控制。

## 协议无关多播协议：PIM-DM、PIM-SM

